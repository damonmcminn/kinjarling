{"version":3,"sources":["../es6/index.js"],"names":[],"mappings":"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","file":"es6/index.js","sourcesContent":["import {install} from 'source-map-support';\ninstall();\n\nimport socketIO from 'socket.io';\nimport {path, groups} from 'parse-config';\nimport express from 'express';\nimport {json} from 'body-parser';\n\nfunction log(data) {\n  console.log(JSON.stringify(data));\n}\n\nconst api = express();\n\nconst io = socketIO({path});\n\nexport default {io, api}\n\napi.use(json());\napi.post('/:group', (req, res) => {\n\n  let {group} = req.params;\n  let data = req.body;\n\n  let {token} = req.headers;\n  // check token; payload includes providerId, exp\n  // check if group matches allowed groups\n\n  let deny = (!token || groups.indexOf(group) === -1);\n\n  if (deny) return res.sendStatus(403);\n  log({timestamp: new Date(), event: 'API call', group, data})\n\n  io.to(group).emit('broadcast', data);\n  res.sendStatus(200);\n\n});\n\nio.on('connection', socket => {\n  let {user, group} = socket.handshake.query\n  \n  log({timestamp: new Date(), event: 'Client connection', user, group})\n  socket.join(group);\n\n  socket.on('broadcast', data => {\n    log({timestamp: new Date(), event: 'Client broadcast', group, data, user})\n    io.to(group).emit('broadcast', data);\n  });\n\n});\n\n\nio.set('authorization', (handshake, callback) => {\n\n  let {group, user} = handshake._query;\n\n  let deny = groups.indexOf(group) === -1;\n\n  if (deny) {\n    log({timestamp: new Date(), event: 'DENY', group, user})\n    callback(new Error('DENY'));\n  } else {\n    callback(null, true);\n  }\n\n});\n"]}